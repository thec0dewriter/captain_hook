#!/usr/bin/env bash
#
# Captain Hook - Pre-commit hook with personality! ğŸ£
# Runs QA checks and attempts auto-fixes on failure
# "Because every repository needs a captain!" âš“
#

set -e

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m' # No Color

# Ensure UV is in PATH
export PATH="$HOME/.local/bin:$HOME/.cargo/bin:$PATH"

echo -e "${CYAN}${BOLD}"
echo "âš“â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âš“"
echo "  ğŸ£ CAPTAIN HOOK - Pre-Commit Quality Inspection ğŸ£"
echo "âš“â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âš“"
echo -e "${NC}\n"

# Track if any check failed
FAILED=0
FIX_ATTEMPTED=0

# Function to run GitHub Copilot CLI to fix issues
attempt_fix_with_copilot() {
    local check_type=$1
    local error_output=$2
    
    echo -e "\n${YELLOW}âš“ ${BOLD}\"Blimey! $check_type be beyond me fixing powers!\"${NC}"
    echo -e "${CYAN}âš“ \"Calling in the ADMIRAL for strategic advice!\"${NC}\n"
    
    # Save error output to temp file
    local error_file=$(mktemp)
    echo "$error_output" > "$error_file"
    
    # Prepare fix prompt
    local fix_prompt="Fix the following $check_type errors in the codebase:\n\n"
    fix_prompt+="Error output:\n$(cat $error_file)\n\n"
    fix_prompt+="Please fix these issues while maintaining code functionality."
    
    echo -e "${BLUE}ğŸº Calling Admiral GitHub Copilot CLI for backup...${NC}"
    
    # Try to use gh copilot if available
    if command -v gh &> /dev/null && gh copilot --version &> /dev/null 2>&1; then
        echo "$fix_prompt" | gh copilot suggest -t shell
        FIX_ATTEMPTED=1
        echo -e "\n${CYAN}âš“ \"There ye have it! Follow the Admiral's orders, sailor!\"${NC}"
    else
        echo -e "${RED}âš ï¸  Admiral Copilot CLI not found!${NC}"
        echo -e "${YELLOW}Install with: ${BOLD}gh extension install github/gh-copilot${NC}"
        echo -e "\n${YELLOW}Error details:${NC}"
        cat "$error_file"
    fi
    
    rm -f "$error_file"
}

# 1. LINTING CHECK
echo -e "${BLUE}ğŸ“‹ Step 1/4: Linting (ruff check)${NC}"
if ! LINT_OUTPUT=$(uv run ruff check . 2>&1); then
    echo -e "${RED}âœ— Linting failed${NC}"
    echo -e "${YELLOW}âš“ \"AVAST! Ye code be full of scurvy issues!\"${NC}\n"
    echo "$LINT_OUTPUT"
    
    echo -e "\n${CYAN}âš“ \"Let me fix what I can, matey...\"${NC}"
    if uv run ruff check . --fix; then
        echo -e "${GREEN}âœ“ Auto-fixed linting issues${NC}"
        echo -e "${CYAN}âš“ \"Unused imports walked the plank!\"${NC}"
        
        # Stage the fixed files
        echo -e "${BLUE}âš“ Staging the cleaned-up code...${NC}"
        git diff --name-only | xargs -r git add
    else
        echo -e "${RED}âœ— Could not auto-fix all issues${NC}"
        attempt_fix_with_copilot "linting" "$LINT_OUTPUT"
        FAILED=1
    fi
else
    echo -e "${GREEN}âœ“ Linting passed${NC}"
    echo -e "${CYAN}âš“ \"Clean code, sailor! Well done!\"${NC}"
fi

# 2. FORMATTING CHECK
echo -e "\n${BLUE}ğŸ¨ Step 2/4: Format checking (ruff format)${NC}"
if ! FORMAT_OUTPUT=$(uv run ruff format --check . 2>&1); then
    echo -e "${RED}âœ— Format check failed${NC}"
    echo -e "${YELLOW}âš“ \"Yer code be messier than a pirate's beard!\"${NC}\n"
    echo "$FORMAT_OUTPUT"
    
    echo -e "\n${CYAN}âš“ \"Time to swab the deck and clean this up!\"${NC}"
    if uv run ruff format .; then
        echo -e "${GREEN}âœ“ Files formatted${NC}"
        echo -e "${CYAN}âš“ \"Shipshape and Bristol fashion!\"${NC}"
        
        # Stage the formatted files
        echo -e "${BLUE}âš“ Staging the tidied-up code...${NC}"
        git diff --name-only | xargs -r git add
    else
        echo -e "${RED}âœ— Formatting failed${NC}"
        attempt_fix_with_copilot "formatting" "$FORMAT_OUTPUT"
        FAILED=1
    fi
else
    echo -e "${GREEN}âœ“ Format check passed${NC}"
    echo -e "${CYAN}âš“ \"Code looks sharp as a cutlass!\"${NC}"
fi

# 3. TYPE CHECKING
echo -e "\n${BLUE}ğŸ” Step 3/4: Type checking (mypy)${NC}"
if ! MYPY_OUTPUT=$(uv run mypy src 2>&1); then
    echo -e "${RED}âœ— Type checking failed${NC}"
    echo -e "${YELLOW}âš“ \"Where be yer type hints, sailor?\"${NC}\n"
    echo "$MYPY_OUTPUT"
    attempt_fix_with_copilot "type checking" "$MYPY_OUTPUT"
    FAILED=1
else
    echo -e "${GREEN}âœ“ Type checking passed${NC}"
    echo -e "${CYAN}âš“ \"Good! Proper type hints, as any respectable sailor knows!\"${NC}"
fi

# 4. TESTS
echo -e "\n${BLUE}ğŸ§ª Step 4/4: Running tests (pytest)${NC}"
if ! TEST_OUTPUT=$(uv run pytest 2>&1); then
    echo -e "${RED}âœ— Tests failed${NC}"
    echo -e "${YELLOW}âš“ \"Yer code be sinkin'! Fix those tests!\"${NC}\n"
    echo "$TEST_OUTPUT"
    attempt_fix_with_copilot "tests" "$TEST_OUTPUT"
    FAILED=1
else
    echo -e "${GREEN}âœ“ Tests passed${NC}"
    echo -e "${CYAN}âš“ \"All hands passed inspection! Well done, crew!\"${NC}"
fi

# Final result
echo -e "\n${CYAN}${BOLD}âš“â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âš“${NC}"
if [ $FAILED -eq 1 ]; then
    echo -e "${RED}${BOLD}âŒ PRE-COMMIT CHECKS FAILED${NC}"
    echo -e "${YELLOW}âš“ \"Not so fast, sailor! Ye can't set sail with broken code!\"${NC}"
    
    if [ $FIX_ATTEMPTED -eq 1 ]; then
        echo -e "\n${CYAN}The Admiral provided some wisdom above.${NC}"
        echo -e "${YELLOW}Review the suggestions and try committing again.${NC}"
    else
        echo -e "\n${YELLOW}Fix the issues above and try committing again.${NC}"
    fi
    
    echo -e "\n${BLUE}âš“ Captain's Tips:${NC}"
    echo -e "  - Run ${YELLOW}'make check'${NC} to see all errors"
    echo -e "  - Run ${YELLOW}'make format'${NC} to auto-format code"
    echo -e "  - Run ${YELLOW}'uv run ruff check . --fix'${NC} to auto-fix linting"
    echo -e "  - Use ${YELLOW}'git commit --no-verify'${NC} to bypass this hook (not recommended)"
    echo -e "\n${CYAN}âš“ \"Get yer code shipshape and try again, matey!\" âš“${NC}"
    
    exit 1
else
    echo -e "${GREEN}${BOLD}âœ… ALL PRE-COMMIT CHECKS PASSED${NC}"
    echo -e "${CYAN}âš“ \"PERMISSION GRANTED! Your code may set sail!\" âš“${NC}"
    echo -e "${CYAN}${BOLD}âš“â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”âš“${NC}\n"
    exit 0
fi
